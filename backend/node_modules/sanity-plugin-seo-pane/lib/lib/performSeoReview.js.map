{"version":3,"file":"performSeoReview.js","names":["performSeoReview","url","keyword","synonyms","previewUrl","URL","searchParams","append","fetch","toString","then","res","text","html","parser","DOMParser","htmlDocument","parseFromString","dataContent","querySelector","innerHTML","fallbackContent","content","title","innerText","description","getAttribute","canonicalUrl","resPreviewUrl","permalink","origin","pathname","filter","Boolean","join","options","titleWidth","paper","Paper","researcher","Researcher","i18n","Jed","domain","locale_data","hiddenTests","assessmentResults","Object","keys","assessments","reduce","parentAcc","parentKey","childAcc","childKey","includes","CurrentAssessment","hasOwnProperty","getResult","assessmentConfig","config","fleschReading","newAssessment","resultsArray","parentCur","newArr","newChild","resultsMapped","mapResults","forEach","key","length","meta","catch","err","error","message"],"sources":["../../src/lib/performSeoReview.js"],"sourcesContent":["import Jed from 'jed'\nimport {Researcher, Paper, assessments} from 'yoastseo'\nimport config from 'yoastseo/src/config/content/default.js'\n\nimport mapResults from './mapResults'\n\nexport default async function performSeoReview(url, keyword, synonyms) {\n  const previewUrl = new URL(url)\n\n  // Tell the API route to just fetch and return the HTML string\n  previewUrl.searchParams.append(`fetch`, `true`)\n\n  // We fetch the /api/preview route to enable us to examine draft/unpublished content\n  // The addition of a &fetch=true searchParam will make the API route perform a fetch request\n  // Returning an object which contains the absoluteUrl of final page and its HTML as a string\n  return fetch(previewUrl.toString())\n    .then((res) => res.text())\n    .then((html) => {\n      const parser = new DOMParser()\n      const htmlDocument = parser.parseFromString(html, `text/html`)\n\n      // Check for the existence of our expected data-content identifier\n      const dataContent = htmlDocument.querySelector(`[data-content=\"main\"]`)?.innerHTML\n      const fallbackContent = htmlDocument.querySelector(`main`)?.innerHTML\n      const content = dataContent ?? fallbackContent\n\n      const title = htmlDocument.querySelector(`title`)?.innerText\n      const description = htmlDocument\n        .querySelector(`meta[name=description]`)\n        ?.getAttribute(`content`)\n\n      const canonicalUrl = htmlDocument.querySelector('[rel=\"canonical\"]')?.getAttribute('href')\n      const resPreviewUrl = canonicalUrl ? new URL(canonicalUrl) : {}\n\n      // This key is for the absolute URL\n      const permalink = [resPreviewUrl?.origin, resPreviewUrl?.pathname].filter(Boolean).join(``)\n\n      // Confusingly, this key is just the pathname\n      const url = resPreviewUrl?.pathname\n      \n      const options = {\n        keyword: keyword ?? ``,\n        synonyms: synonyms ?? ``,\n        url: url ?? ``,\n        permalink: permalink ?? ``,\n        title,\n        // TODO: Could not find where/how Yoast measures this\n        titleWidth: 600, \n        description,\n        // TODO: Not yet configurable\n        // locale: langCulture.replace('-', '_'),\n      }\n\n      const paper = new Paper(content, options)\n      const researcher = new Researcher(paper)\n      const i18n = new Jed({\n        domain: 'js-text-analysis',\n        // eslint-disable-next-line camelcase\n        locale_data: {\n          'js-text-analysis': {\n            '': {},\n          },\n        },\n      })\n\n      const hiddenTests = [`UrlLengthAssessment`, `TaxonomyTextLengthAssessment`]\n\n      // Parent keys are \"seo\" and \"readability\"\n      // Some assessments are objects, some are functions\n      const assessmentResults = Object.keys(assessments).reduce((parentAcc, parentKey) => {\n        // Inside each key are the tests\n        parentAcc[parentKey] = Object.keys(assessments[parentKey]).reduce((childAcc, childKey) => {\n          // Some assessments have been depreciated\n          if (hiddenTests.includes(childKey)) {\n            // console.log(`Hidden:`, childKey)\n            return childAcc\n          }\n\n          const CurrentAssessment = assessments[parentKey][childKey]\n\n          // But not all of them are objects with the `getResult` function\n          if (\n            typeof CurrentAssessment === `object` &&\n            CurrentAssessment.hasOwnProperty(`getResult`)\n          ) {\n            childAcc[childKey] = CurrentAssessment.getResult(paper, researcher, i18n)\n          } else if (typeof CurrentAssessment === `function`) {\n            let assessmentConfig = {}\n\n            switch (childKey) {\n              case 'FleschReadingEaseAssessment':\n                assessmentConfig = config.fleschReading\n                break\n              default:\n                break\n            }\n\n            const newAssessment = new CurrentAssessment(assessmentConfig)\n            childAcc[childKey] = newAssessment.getResult(paper, researcher, i18n)\n          } else {\n            // console.log(`Skipped:`, childKey, thisAssessment)\n            childAcc[childKey] = {text: `Test Skipped`}\n          }\n\n          return childAcc\n        }, {})\n\n        return parentAcc\n      }, {})\n\n      // Now reduce these tests down to a flattened array\n      const resultsArray = Object.keys(assessmentResults).reduce((parentAcc, parentCur) => {\n        const newArr = Object.keys(assessmentResults[parentCur]).reduce((childAcc, childKey) => {\n          const newChild = assessmentResults[parentCur][childKey]\n\n          return newChild ? [...childAcc, newChild] : childAcc\n        }, [])\n\n        return newArr ? [...parentAcc, ...newArr] : parentAcc\n      }, [])\n\n      // mapResults function is a lightly edited function copied from the Yoast WordPress plugin\n      // It adds more details to each score\n      // https://github.com/Yoast/wordpress-seo/blob/0742e9b6ba4c0d6ae9d65223267a106b92a6a4a1/js/src/components/contentAnalysis/mapResults.js\n      const resultsMapped = mapResults(resultsArray)\n\n      // Finally, remove any empty keys\n      Object.keys(resultsMapped).forEach((key) => {\n        if (!resultsMapped[key].length) {\n          delete resultsMapped[key]\n        }\n      })\n\n      return {\n        permalink,\n        meta: {\n          title,\n          description,\n        },\n        resultsMapped,\n      }\n    })\n    .catch((err) => ({\n      error: err.message,\n    }))\n}\n"],"mappings":"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"}